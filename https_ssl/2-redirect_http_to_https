#!/usr/bin/env bash
# This script configures HAProxy to redirect HTTP traffic to HTTPS

# Backup the original HAProxy configuration file
sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

# Configure HAProxy for HTTP to HTTPS redirection
cat <<EOL | sudo tee /etc/haproxy/haproxy.cfg
frontend www-http
    bind *:80
    mode http
    redirect scheme https code 301 if !{ ssl_fc }

frontend www-https
    bind *:443 ssl crt /etc/letsencrypt/live/www.yourdomain.com/fullchain.pem
    reqadd X-Forwarded-Proto:\ https
    default_backend www-backend

backend www-backend
    server web-server 54.224.230.69
EOL

# Restart HAProxy
sudo service haproxy restart

# Wait for HAProxy to restart
sleep 2

# Check if HAProxy is redirecting HTTP to HTTPS
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://shyakx.tech)

# Compare the obtained HTTP status with the expected value
EXPECTED_STATUS="301"

if [ "$HTTP_STATUS" = "$EXPECTED_STATUS" ]; then
    echo "HAProxy is redirecting HTTP to HTTPS"
else
    echo "HAProxy is not redirecting HTTP to HTTPS"
    echo "Expected: $EXPECTED_STATUS"
    echo "Got: $HTTP_STATUS"
fi
